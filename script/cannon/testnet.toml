name = "pike-market"
version = "0.1.0"
description = "Local markets for Pike testnet deployment"

# `salt` here only affects proxy contract
[setting.salt]
description = "Change this to a unique string when deploying multiple instances of the ptoken. Note that only the proxy contract will be unique."
defaultValue = "main"

[setting.owner]
description = "Admin user for the system"
defaultValue = "0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266"

[setting.confRole]
defaultValue = "0x434f4e464947555241544f520000000000000000000000000000000000000000"

[setting.supGuardRole]
defaultValue = "0x535550504c595f4341505f475541524449414e00000000000000000000000000"

[setting.borGuardRole]
defaultValue = "0x424f52524f575f4341505f475541524449414e00000000000000000000000000"

[setting.pauseGuardRole]
defaultValue = "0x50415553455f475541524449414e000000000000000000000000000000000000"

[setting.reserveManagerRole]
defaultValue = "0x524553455256455f4d414e414745520000000000000000000000000000000000"

[setting.reserveWithdrawerRole]
defaultValue = "0x524553455256455f574954484452415745520000000000000000000000000000"

[setting.usdc]
defaultValue = "0x036CbD53842c5426634e7929541eC2318f3dCF7e"

[setting.weth]
defaultValue = "0x4200000000000000000000000000000000000006"

[setting.initial_exchange_rate]
defaultValue = "1000000000000000000" # 1e18

[setting.reserve_factor]
defaultValue = "50000000000000000" # 5e16 = 5%

[setting.protocol_seize_factor]
defaultValue = "10000000000000000" # 1e16 = 1%

[setting.max_borrow_rate]
defaultValue = "5000000000000" # 5e12

[setting.decimals]
defaultValue = "18"

[contract.InitialModuleBundle]
artifact = "InitialModuleBundle"
salt = "<%= settings.salt %>"
create2 = true

[contract.DoubleJumpRateModel]
artifact = "DoubleJumpRateModel"

[contract.RBACModule]
artifact = "RBACModule"

[contract.PTokenModule]
artifact = "PTokenModule"

[contract.RiskEngineModule]
artifact = "RiskEngineModule"

[contract.OracleEngine]
artifact = "OracleEngine"

[contract.ChainlinkOracleProvider]
artifact = "src/oracles/ChainlinkOracleProvider.sol:ChainlinkOracleProvider"
args = ["<%= AddressZero %>"]

[contract.PythOracleProvider]
artifact = "src/oracles/PythOracleProvider.sol:PythOracleProvider"
args = ["0xA2aa501b19aff244D90cc15a4Cf739D2725B5729"]

#PToken
[router.PTokenRouter]
contracts = [
    "InitialModuleBundle",
    "DoubleJumpRateModel",
    "RBACModule",
    "PTokenModule",
]

#Core
[router.CoreRouter]
contracts = [
    "InitialModuleBundle",
    "RBACModule",
    "RiskEngineModule",
]

[clone.oracleEngine]
source = "universal-upgradeable-proxy:0.1.0@erc1967-upgrade"
options.implementation = "<%= contracts.OracleEngine.address %>"
options.owner = "<%= settings.owner %>"
options.abi = "<%= JSON.stringify(contracts.OracleEngine.abi) %>"
options.salt = "oracleEngine"

[clone.chainlinkOracleProvider]
source = "universal-upgradeable-proxy:0.1.0@erc1967-upgrade"
options.implementation = "<%= contracts.ChainlinkOracleProvider.address %>"
options.owner = "<%= settings.owner %>"
options.abi = "<%= JSON.stringify(contracts.ChainlinkOracleProvider.abi) %>"
options.salt = "chainlinkOracleProvider"

[clone.pythOracleProvider]
source = "universal-upgradeable-proxy:0.1.0@erc1967-upgrade"
options.implementation = "<%= contracts.PythOracleProvider.address %>"
options.owner = "<%= settings.owner %>"
options.abi = "<%= JSON.stringify(contracts.PythOracleProvider.abi) %>"
options.salt = "pythOracleProvider"

[clone.pUSDC]
source = "universal-upgradeable-proxy:0.1.0@module-upgrade"
options.implementation = "<%= contracts.PTokenRouter.address %>"
options.owner = "<%= settings.owner %>"
options.abi = "<%= JSON.stringify(contracts.PTokenRouter.abi) %>"
options.salt = "pUSDC"

[clone.pWETH]
source = "universal-upgradeable-proxy:0.1.0@module-upgrade"
options.implementation = "<%= contracts.PTokenRouter.address %>"
options.owner = "<%= settings.owner %>"
options.abi = "<%= JSON.stringify(contracts.PTokenRouter.abi) %>"
options.salt = "pWETH"

[clone.core]
source = "universal-upgradeable-proxy:0.1.0@module-upgrade"
options.implementation = "<%= contracts.CoreRouter.address %>"
options.owner = "<%= settings.owner %>"
options.abi = "<%= JSON.stringify(contracts.CoreRouter.abi) %>"

[invoke.initialize_oe]
target = ["oracleEngine.Proxy"]
func = "initialize"
args = ["<%= settings.owner %>"]
depends = [ "clone.oracleEngine"]

[invoke.initialize_chainlink]
target = ["chainlinkOracleProvider.Proxy"]
func = "initialize"
args = ["<%= settings.owner %>"]
depends = [ "clone.chainlinkOracleProvider"]

[invoke.initialize_pyth]
target = ["pythOracleProvider.Proxy"]
func = "initialize"
args = ["<%= settings.owner %>"]
depends = [ "clone.pythOracleProvider"]

[invoke.chainlink_set_weth]
target = ["chainlinkOracleProvider.Proxy"]
func = "setAssetConfig"
from = "<%= settings.owner %>"
args = ["<%= settings.weth %>", "0x4aDC67696bA383F43DD60A9e78F2C97Fbbfc7cb1", "<%= MaxUint256 %>"]
depends = [ "invoke.initialize_chainlink"]

[invoke.chainlink_set_usdc]
target = ["chainlinkOracleProvider.Proxy"]
func = "setAssetConfig"
from = "<%= settings.owner %>"
args = ["<%= settings.usdc %>", "0xd30e2101a97dcbAeBCBC04F14C3f624E67A35165", "<%= MaxUint256 %>"]
depends = [ "invoke.initialize_chainlink"]

[invoke.pyth_set_weth]
target = ["pythOracleProvider.Proxy"]
func = "setAssetConfig"
from = "<%= settings.owner %>"
args = ["<%= settings.weth %>", "0xff61491a931112ddf1bd8147cd1b641375f79f5825126d665480874634fd0ace", "<%= MaxUint256 %>"]
depends = [ "invoke.initialize_pyth"]

[invoke.pyth_set_usdc]
target = ["pythOracleProvider.Proxy"]
func = "setAssetConfig"
from = "<%= settings.owner %>"
args = ["<%= settings.usdc %>", "0xeaa020c61cc479712813461ce153894a96a6c00b21ed0cfc2798d1f9a9e9c94a", "<%= MaxUint256 %>"]
depends = [ "invoke.initialize_pyth"]

[invoke.oe_set_weth]
target = ["oracleEngine.Proxy"]
func = "setAssetConfig"
from = "<%= settings.owner %>"
args = ["<%= settings.weth %>", "<%= chainlinkOracleProvider.Proxy.address %>", "<%= pythOracleProvider.Proxy.address %>", "0", "0"]
depends = [ "invoke.pyth_set_weth", "invoke.chainlink_set_weth"]

[invoke.oe_set_usdc]
target = ["oracleEngine.Proxy"]
func = "setAssetConfig"
from = "<%= settings.owner %>"
args = ["<%= settings.usdc %>", "<%= chainlinkOracleProvider.Proxy.address %>", "<%= pythOracleProvider.Proxy.address %>", "0", "0"]
depends = [ "invoke.pyth_set_usdc", "invoke.chainlink_set_usdc"]

[invoke.initialize_pUSDC]
target = [ "pUSDC.Proxy" ]
abi = "<%= JSON.stringify(contracts.PTokenModule.abi) %>"
from = "<%= settings.owner %>"
func = "initialize"
args = ["<%= settings.usdc %>", "<%= core.Proxy.address %>", "<%= settings.initial_exchange_rate %>", "<%= settings.reserve_factor %>", "<%= settings.protocol_seize_factor %>", "<%= settings.max_borrow_rate %>", "pike-usdc", "pUSDC", "<%= settings.decimals %>"]
depends = [ "clone.pUSDC",  "clone.core"]

[invoke.pUSDC_reserve_manager]
target = [ "pUSDC.Proxy" ]
abi = "<%= JSON.stringify(contracts.RBACModule.abi) %>"
from = "<%= settings.owner %>"
func = "grantPermission"
args = ["<%= settings.reserveManagerRole %>", "<%= settings.owner %>"]
depends = [ "clone.pUSDC" ]

[invoke.pUSDC_reserve_withdrawer]
target = [ "pUSDC.Proxy" ]
abi = "<%= JSON.stringify(contracts.RBACModule.abi) %>"
from = "<%= settings.owner %>"
func = "grantPermission"
args = ["<%= settings.reserveWithdrawerRole %>", "<%= settings.owner %>"]
depends = [ "clone.pUSDC" ]

[invoke.set_pUSDC_local_configurator]
target = [ "pUSDC.Proxy" ]
abi = "<%= JSON.stringify(contracts.RBACModule.abi) %>"
from = "<%= settings.owner %>"
func = "grantPermission"
args = ["<%= settings.confRole %>", "<%= settings.owner %>"]
depends = [ "clone.pUSDC" ]

[invoke.initialize_pWETH]
target = [ "pWETH.Proxy" ]
abi = "<%= JSON.stringify(contracts.PTokenModule.abi) %>"
from = "<%= settings.owner %>"
func = "initialize"
args = ["<%= settings.weth %>", "<%= core.Proxy.address %>", "<%= settings.initial_exchange_rate %>", "<%= settings.reserve_factor %>", "<%= settings.protocol_seize_factor %>", "<%= settings.max_borrow_rate %>", "pike-weth", "pWETH", "<%= settings.decimals %>"]
depends = [ "clone.pWETH", "clone.core" ]

[invoke.pWETH_reserve_manager]
target = [ "pWETH.Proxy" ]
abi = "<%= JSON.stringify(contracts.RBACModule.abi) %>"
from = "<%= settings.owner %>"
func = "grantPermission"
args = ["<%= settings.reserveManagerRole %>", "<%= settings.owner %>"]
depends = [ "clone.pWETH" ]

[invoke.pWETH_reserve_withdrawer]
target = [ "pWETH.Proxy" ]
abi = "<%= JSON.stringify(contracts.RBACModule.abi) %>"
from = "<%= settings.owner %>"
func = "grantPermission"
args = ["<%= settings.reserveWithdrawerRole %>", "<%= settings.owner %>"]
depends = [ "clone.pWETH" ]

[invoke.set_pWETH_local_configurator]
target = [ "pWETH.Proxy" ]
abi = "<%= JSON.stringify(contracts.RBACModule.abi) %>"
from = "<%= settings.owner %>"
func = "grantPermission"
args = ["<%= settings.confRole %>", "<%= settings.owner %>"]
depends = [ "clone.pWETH" ]

[invoke.config_pUSDC_IRM]
target = [ "pUSDC.Proxy" ]
abi = "<%= JSON.stringify(contracts.DoubleJumpRateModel.abi) %>"
from = "<%= settings.owner %>"
func = "configureInterestRateModel"
args = ["<%= parseUnits('1.5', 16) %>", "0", "<%= parseUnits('8.33', 16) %>", "<%= parseUnits('4.3', 18) %>", "0", "<%= parseUnits('80', 16) %>"]
depends = [ "clone.pUSDC", "invoke.set_pUSDC_local_configurator" ]

[invoke.config_pWETH_IRM]
target = [ "pWETH.Proxy" ]
abi = "<%= JSON.stringify(contracts.DoubleJumpRateModel.abi) %>"
from = "<%= settings.owner %>"
func = "configureInterestRateModel"
args = ["<%= parseUnits('1.5', 16) %>", "0", "<%= parseUnits('8.33', 16) %>", "<%= parseUnits('4.3', 18) %>", "0", "<%= parseUnits('80', 16) %>"]
depends = [ "clone.pWETH", "invoke.set_pWETH_local_configurator" ]

[invoke.set_oracle]
target = [ "core.Proxy" ]
abi = "<%= JSON.stringify(contracts.RiskEngineModule.abi) %>"
from = "<%= settings.owner %>"
func = "setOracle"
args = ["<%= oracleEngine.Proxy.address %>"]
depends = ["invoke.set_core_configurator"]

[invoke.set_close_factor]
target = [ "core.Proxy" ]
abi = "<%= JSON.stringify(contracts.RiskEngineModule.abi) %>"
from = "<%= settings.owner %>"
func = "setCloseFactor"
args = ["<%= parseUnits('50', 16) %>"]
depends = ["invoke.set_core_configurator"]

[invoke.set_core_configurator]
target = [ "core.Proxy" ]
abi = "<%= JSON.stringify(contracts.RBACModule.abi) %>"
from = "<%= settings.owner %>"
func = "grantPermission"
args = ["<%= settings.confRole %>", "<%= settings.owner %>"]

[invoke.set_core_pause_guard]
target = [ "core.Proxy" ]
abi = "<%= JSON.stringify(contracts.RBACModule.abi) %>"
from = "<%= settings.owner %>"
func = "grantPermission"
args = ["<%= settings.pauseGuardRole %>", "<%= settings.owner %>"]

[invoke.set_core_supply_guard_pUSDC]
target = [ "core.Proxy" ]
abi = "<%= JSON.stringify(contracts.RBACModule.abi) %>"
from = "<%= settings.owner %>"
func = "grantNestedPermission"
args = ["<%= settings.supGuardRole %>", "<%= pUSDC.Proxy.address %>", "<%= settings.owner %>"]
depends = [ "clone.pUSDC"]

[invoke.set_core_supply_guard_pWETH]
target = [ "core.Proxy" ]
abi = "<%= JSON.stringify(contracts.RBACModule.abi) %>"
from = "<%= settings.owner %>"
func = "grantNestedPermission"
args = ["<%= settings.supGuardRole %>", "<%= pWETH.Proxy.address %>", "<%= settings.owner %>"]
depends = [ "clone.pWETH"]

[invoke.set_core_borrow_guard_pUSDC]
target = [ "core.Proxy" ]
abi = "<%= JSON.stringify(contracts.RBACModule.abi) %>"
from = "<%= settings.owner %>"
func = "grantNestedPermission"
args = ["<%= settings.borGuardRole %>", "<%= pUSDC.Proxy.address %>", "<%= settings.owner %>"]

[invoke.set_core_borrow_guard_pWETH]
target = [ "core.Proxy" ]
abi = "<%= JSON.stringify(contracts.RBACModule.abi) %>"
from = "<%= settings.owner %>"
func = "grantNestedPermission"
args = ["<%= settings.borGuardRole %>", "<%= pWETH.Proxy.address %>", "<%= settings.owner %>"]

[invoke.set_pUSDC_configurator]
target = [ "core.Proxy" ]
abi = "<%= JSON.stringify(contracts.RBACModule.abi) %>"
from = "<%= settings.owner %>"
func = "grantNestedPermission"
args = ["<%= settings.confRole %>", "<%= pUSDC.Proxy.address %>","<%= settings.owner %>"]

[invoke.set_pWETH_configurator]
target = [ "core.Proxy" ]
abi = "<%= JSON.stringify(contracts.RBACModule.abi) %>"
from = "<%= settings.owner %>"
func = "grantNestedPermission"
args = ["<%= settings.confRole %>", "<%= pWETH.Proxy.address %>","<%= settings.owner %>"]

[invoke.support_pWETH]
target = [ "core.Proxy" ]
abi = "<%= JSON.stringify(contracts.RiskEngineModule.abi) %>"
from = "<%= settings.owner %>"
func = "supportMarket"
args = ["<%= pWETH.Proxy.address %>"]
depends = ["invoke.set_core_configurator"]

[invoke.support_pUSDC]
target = [ "core.Proxy" ]
abi = "<%= JSON.stringify(contracts.RiskEngineModule.abi) %>"
from = "<%= settings.owner %>"
func = "supportMarket"
args = ["<%= pUSDC.Proxy.address %>"]
depends = ["invoke.set_core_configurator"]

[invoke.set_pWETH_collateral_factor]
target = [ "core.Proxy" ]
abi = "<%= JSON.stringify(contracts.RiskEngineModule.abi) %>"
from = "<%= settings.owner %>"
func = "setCollateralFactor"
args = ["<%= pWETH.Proxy.address %>", "<%= parseUnits('72.5', 16) %>", "<%= parseUnits('82.5', 16) %>"]
depends = [ "invoke.support_pWETH" ]

[invoke.set_pUSDC_collateral_factor]
target = [ "core.Proxy" ]
abi = "<%= JSON.stringify(contracts.RiskEngineModule.abi) %>"
from = "<%= settings.owner %>"
func = "setCollateralFactor"
args = ["<%= pUSDC.Proxy.address %>", "<%= parseUnits('74.5', 16) %>", "<%= parseUnits('84.5', 16) %>"]
depends = [ "invoke.support_pUSDC" ]

[invoke.set_liquidation_incentive]
target = [ "core.Proxy" ]
abi = "<%= JSON.stringify(contracts.RiskEngineModule.abi) %>"
from = "<%= settings.owner %>"
func = "setLiquidationIncentive"
args = ["<%= parseUnits('1.08', 18) %>"]
depends = ["invoke.set_core_configurator"]

[invoke.set_borrow_cap]
target = [ "core.Proxy" ]
abi = "<%= JSON.stringify(contracts.RiskEngineModule.abi) %>"
from = "<%= settings.owner %>"
func = "setMarketBorrowCaps"
args = [["<%= pWETH.Proxy.address %>", "<%= pUSDC.Proxy.address %>"], ["<%= MaxUint256 %>", "<%= MaxUint256 %>"]]
depends = [ "invoke.set_core_borrow_guard_pWETH", "invoke.set_core_borrow_guard_pUSDC" ]

[invoke.set_supply_cap]
target = [ "core.Proxy" ]
abi = "<%= JSON.stringify(contracts.RiskEngineModule.abi) %>"
from = "<%= settings.owner %>"
func = "setMarketSupplyCaps"
args = [["<%= pWETH.Proxy.address %>", "<%= pUSDC.Proxy.address %>"], ["<%= MaxUint256 %>", "<%= MaxUint256 %>"]]
depends = [ "invoke.set_core_supply_guard_pWETH", "invoke.set_core_supply_guard_pUSDC" ]


